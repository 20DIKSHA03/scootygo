{% extends "base.html" %}
{% block content %}
<h2>My Bookings</h2>
<div id="bookingsList" class="mt-3">
  <!-- bookings injected -->
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://js.stripe.com/v3/"></script>

<script>
async function loadMyBookings(){
  if(!isLoggedIn()){ 
    showAlert('Please login to view bookings','warning'); 
    window.location='/login/'; 
    return; 
  }

  const res = await fetchAuth('/api/bookings/');
  if(!res.ok){ 
    showAlert('Failed to load bookings','danger'); 
    return; 
  }

  const data = await res.json();
  const container = document.getElementById('bookingsList');
  if(!data.length){ 
    container.innerHTML = '<div class="alert alert-info">No bookings yet</div>'; 
    return; 
  }

  container.innerHTML = '';
  data.forEach(b => {
    const div = document.createElement('div');
    div.className = 'card mb-3';
    div.innerHTML = `
      <div class="card-body">
        <h5 class="card-title">${b.vehicle} — ${b.status}</h5>
        <p class="card-text">
          <strong>From:</strong> ${new Date(b.start_time).toLocaleString()} <br>
          <strong>To:</strong> ${new Date(b.end_time).toLocaleString()}
        </p>
        <p><strong>Price:</strong> ₹${b.total_price}</p>
        <div>
          ${b.status === 'PENDING' 
            ? `<button class="btn btn-success btn-sm" onclick="startStripeCheckout(${b.id})">Pay</button>` 
            : ''}
          ${b.status === 'PENDING' || b.status === 'CONFIRMED'
            ? `<button class="btn btn-danger btn-sm" onclick="cancelBooking(${b.id})">Cancel</button>` 
            : ''}
          ${b.status === 'CONFIRMED' ? `<span class="badge bg-success">Confirmed</span>` : ''}
          ${b.status === 'CANCELLED' ? `<span class="badge bg-danger">Cancelled</span>` : ''}
        </div>
      </div>`;
    container.appendChild(div);
  });
}

async function startStripeCheckout(bookingId){
  if(!isLoggedIn()){ 
    showAlert('Please login', 'warning'); 
    window.location = '/login/'; 
    return; 
  }

  try {
    const resp = await fetchAuth(`/api/payments/create-checkout-session/${bookingId}/`, {
      method: 'POST'
    });

    if(!resp.ok){
      const err = await resp.json();
      showAlert('Failed to create checkout session: ' + JSON.stringify(err), 'danger');
      return;
    }

    const data = await resp.json();
    const sessionId = data.sessionId;
    const publishableKey = data.publishableKey;

    if(!sessionId || !publishableKey){
      showAlert('Invalid checkout data from server', 'danger');
      return;
    }

    const stripe = Stripe(publishableKey);
    const { error } = await stripe.redirectToCheckout({ sessionId });
    if(error){
      showAlert('Stripe redirect error: ' + error.message, 'danger');
    }
  } catch (e){
    console.error(e);
    showAlert('Error starting payment: ' + e.message, 'danger');
  }
}

async function cancelBooking(bookingId){
  if(!confirm('Are you sure you want to cancel this booking?')) return;

  try {
    const res = await fetchAuth(`/api/bookings/${bookingId}/cancel/`, { method: 'POST' });

    let data;
    try {
      data = await res.json();   // JSON normally
    } catch {
      data = { detail: await res.text() }; // fallback to raw text
    }

    if(res.ok){
      let msg = 'Booking cancelled.';
      if(data.refund && data.refund.refunded){
        msg += ` Refund: ₹${data.refund.refunded} (Penalty: ₹${data.refund.penalty || 0})`;
      }
      showAlert(msg, 'info');
      loadMyBookings();
    } else {
      showAlert('Cancellation failed: ' + (data.detail || JSON.stringify(data)), 'danger');
    }
  } catch(e){
    console.error(e);
    showAlert('Error cancelling booking: ' + e.message, 'danger');
  }
}

// ✅ Handle payment success/cancel alerts on return
document.addEventListener('DOMContentLoaded', () => {
  const params = new URLSearchParams(window.location.search);
  if(params.get('payment') === 'success'){
    showAlert('Payment successful! Your booking is confirmed.', 'success');
    loadMyBookings(); 
    window.history.replaceState({}, document.title, window.location.pathname);
  }
  if(params.get('payment') === 'cancel'){
    showAlert('Payment was cancelled.', 'warning');
    window.history.replaceState({}, document.title, window.location.pathname);
  }
  loadMyBookings();
});
</script>
{% endblock %}
